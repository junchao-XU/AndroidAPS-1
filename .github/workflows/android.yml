name: Android CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        # ç¡®ä¿è·å–å®Œæ•´å†å²ï¼Œé¿å… uncommitted changes é”™è¯¯
        fetch-depth: 0

    # ğŸ” å¼ºåˆ¶æ¸…ç†æ‰€æœ‰è‡ªåŠ¨ä¿®æ”¹ï¼ˆå…³é”®ï¼è§£å†³ä½ çš„æ„å»ºå¤±è´¥ï¼‰
    - name: Clean uncommitted changes
      run: |
        git reset --hard
        git clean -xffd

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Release APK
      env:
        # âœ… é€šè¿‡ç¯å¢ƒå˜é‡ä¼ å…¥ç­¾åä¿¡æ¯ï¼ˆGradle ä¼šè‡ªåŠ¨è¯»å–ï¼‰
        STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        STORE_FILE: ${{ secrets.STORE_FILE }}
      run: |
        # æ‰§è¡Œæ„å»º
        ./gradlew assembleFullRelease

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: aaps-apks
        path: app/build/outputs/apk/full/release/
        # æ¨èï¼šå‹ç¼©æ–‡ä»¶ï¼Œé¿å…è·¯å¾„é—®é¢˜
        if-no-files-found: warn
